<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>to gif</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.0/TweenMax.min.js"></script>
    <script src="./gif.js"></script>
</head>
<body>
    <img src="../sourcesvgs/kka.svg" id="myimg" />
    <canvas id="mycanv" width="360" height="360"></canvas>
    <script>
        var mycanv = document.querySelector('canvas#mycanv');
        var recorder=null;
        var gif=new GIF({
            workers:4,
            quality:10,
            background:'#fff',
            width:mycanv.width,
            height:mycanv.height,
        });
        var ctx = mycanv.getContext("2d",{
            willReadFrequently:true
        });
        var mysvg = document.querySelector('img#myimg');
        function drawImage(){
            ctx.drawImage(mysvg,0,0);
            return mycanv;
        }
        function wait(delayInMS) {
            return new Promise((resolve) => setTimeout(resolve, delayInMS));
        }
        function drawFrame(){
            requestAnimationFrame(()=>{drawImage()});
        }
        async function convert({dur,fps}={dur:6,fps:25}){
            var duration=dur*1000;
            var frames = fps * dur;
            recorder = new MediaRecorder(mycanv.captureStream(fps));
            recorder.ondataavailable = function (ev) {
                if (ev.data && ev.data.size) {
                    console.log(ev.data);
                    var frameUrl = URL.createObjectURL(new Blob([data]));
                    var anImg= new Image(mycanv.width,mycanv.height);
                    anImg.src=frameUrl;
                    gif.addFrame(anImg);
                }
            }
            for (var i = 0;i<frames;i++){
                await wait(1000 / fps).then(()=>{
                    drawFrame();
                });
            }
            /* await wait(1000).then(()=>{
                gif.on('finished', function(blob) {
                    console.log(URL.createObjectURL(blob));
                    window.open(URL.createObjectURL(blob));
                });
                gif.render();
            }); */
            gif.on('finished', function(blob) {
                console.log(URL.createObjectURL(blob));
                window.open(URL.createObjectURL(blob));
            });
            recorder.onstop=(ev)=>{
                gif.render();
            }
            setTimeout(()=>{
                recorder.stop();
            },duration);
        }
    </script>
</body>
</html>